name: Dependency Update Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check Python dependencies
      working-directory: ./backend
      run: |
        pip install pip-audit
        pip-audit -r requirements.txt || true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Check npm dependencies
      working-directory: ./frontend
      run: |
        npm audit || true
        npx npm-check-updates || true

    - name: Create issue if vulnerabilities found
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'Security: Dependency Updates Available';
          const body = 'Automated dependency check found updates or vulnerabilities. Please review and update dependencies.';
          
          // Check if issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['dependencies', 'security']
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'security']
            });
          }
      continue-on-error: true

# Made with Bob
